<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JC Mechanical Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }

        header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .logout-btn {
            padding: 6px 12px;
            background-color: #d9534f;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 10px;
        }
        .logout-btn:hover { background-color: #c9302c; }

        .dashboard-logo {
            max-width: 200px;
            width: 100%;
            height: auto;
        }

        .kpi-wrap {
            display: flex;
            justify-content: center;
            margin-bottom: 18px;
        }

        .kpi-card {
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 18px;
            width: 100%;
            max-width: 520px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .ftc-percentage {
            font-size: 36px;
            font-weight: 800;
            line-height: 1.1;
            margin-top: 6px;
        }

        .ftc-sub {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        .progress { height: 18px; }

        .mini-metrics {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
            margin-top: 14px;
        }

        .mini-metric {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }

        .mini-metric .label {
            font-size: 12px;
            color: #64748b;
        }

        .mini-metric .value {
            font-size: 18px;
            font-weight: 700;
            margin-top: 2px;
            color: #0f172a;
        }

        .section-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            max-width: 980px;
            margin: 0 auto 18px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .table td, .table th {
            vertical-align: middle;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            margin-top: 18px;
            color: #6b7280;
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.5rem; }
            .mini-metrics { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <h1>JC Mechanical Dashboard</h1>
    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
</header>

<div class="text-center mb-4">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Company Logo" class="dashboard-logo">
</div>

{# ----------------------------
   FTC Progress Bar Color
   ---------------------------- #}
{% set ftc_bar_class =
    'bg-success' if first_time_completion_pct >= first_time_completion_target
    else 'bg-warning' if first_time_completion_pct >= 75
    else 'bg-danger'
%}

<div class="kpi-wrap">
    <div class="kpi-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="text-muted" style="font-size:13px;">Quality KPI</div>
                <div style="font-size:18px; font-weight:700;">First-Time Completion</div>

                <div class="ftc-percentage">
                    {{ first_time_completion_pct }}%
                </div>

                <div class="ftc-sub">
                    Target: {{ first_time_completion_target }}% â€¢ Completed jobs counted: {{ completed_jobs }}
                </div>
            </div>

            <div class="text-end">
                <div class="text-muted" style="font-size:12px;">Last refreshed</div>
                <div style="font-size:13px; font-weight:700;">{{ last_refresh }}</div>
            </div>
        </div>

        <div class="mt-3">
            <div class="progress">
                <div
                    id="ftc-progress-bar"
                    class="progress-bar {{ ftc_bar_class }} progress-bar-striped"
                    role="progressbar"
                    data-ftc="{{ first_time_completion_pct }}"
                    aria-valuenow="{{ first_time_completion_pct }}"
                    aria-valuemin="0"
                    aria-valuemax="100">
                    {{ first_time_completion_pct }}%
                </div>
            </div>
        </div>

        <div class="mini-metrics">
            <div class="mini-metric">
                <div class="label">First-time (1 appt)</div>
                <div class="value">{{ first_time_completed }}</div>
            </div>
            <div class="mini-metric">
                <div class="label">Repeat visit (2+ appts)</div>
                <div class="value">{{ repeat_visit_completed }}</div>
            </div>
            <div class="mini-metric">
                <div class="label">Repeat-visit rate</div>
                <div class="value">{{ repeat_visit_pct }}%</div>
            </div>
        </div>
    </div>
</div>



<div class="section-card">
    <div class="section-title">Repeat-Visit Completed Jobs (2+ appointments)</div>
    <div class="text-muted" style="font-size:13px; margin-bottom:10px;">
        These jobs required at least one return trip. Reviewing these is the fastest way to push First-Time Completion up.
    </div>

    <div class="table-responsive">
        <table class="table table-sm table-striped align-middle">
            <thead>
                <tr>
                    <th>Completed</th>
                    <th>Customer</th>
                    <th>Appointments</th>
                    <th>Status</th>
                    <th>Description</th>
                    <th>Job ID</th>
                </tr>
            </thead>
            <tbody>
                {% if repeat_jobs and repeat_jobs|length > 0 %}
                    {% for r in repeat_jobs %}
                        <tr>
                            <td>{{ r.completed_at_central }}</td>
                            <td>{{ r.customer_name }}</td>
                            <td><span class="badge text-bg-secondary">{{ r.num_appointments }}</span></td>
                            <td>{{ r.work_status }}</td>
                            <td style="max-width: 320px; white-space: normal;">{{ r.description }}</td>
                            <td><code>{{ r.job_id }}</code></td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" class="text-muted">No repeat-visit completed jobs found.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
<div class="text-center mb-3">
    <p class="text-muted">Last refreshed: {{ last_refresh }}</p>
</div>


<footer>&copy; 2026 Hollcroft Data Consulting</footer>

<script>
    // Set progress bar width safely (handles decimals)
    const ftcBar = document.getElementById("ftc-progress-bar");
    if (ftcBar) {
        const pct = parseFloat(ftcBar.dataset.ftc || "0");
        const clamped = Math.max(0, Math.min(100, pct));
        ftcBar.style.width = clamped + "%";
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
